spec:
  inputs:
    stage:
      default: deploy
    changes_md_token:
      default: $CHANGES_MD_TOKEN
    changelog_file:
      default: CHANGELOG.md
    release_notes_file:
      default: release_notes.txt
---
prepare-release-notes:
  stage: $[[ inputs.stage ]]
  image: docker-proxy.kontur.host/ubuntu:24.04
  before_script:
    - sed -i 's|http://archive.ubuntu.com/ubuntu|mirror://mirrorlist-ubuntu.kontur.host/mirrors.txt|g' /etc/apt/sources.list.d/ubuntu.sources
    - apt-get update && apt-get install -y git curl jq
  script:
    - |
      CHANGELOG_FILE="$[[ inputs.changelog_file ]]"
      touch "$CHANGELOG_FILE"
      LAST_DATE=$(tail -n 1 "$CHANGELOG_FILE" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z' || echo "")
      RELEASE_NOTES=$(curl --header "Authorization: Bearer $[[ inputs.changes_md_token ]]" \
        --url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests?state=merged&updated_after=${LAST_DATE}" \
        | jq -r --arg DATE "$LAST_DATE" 'map(select(.merged_at > $DATE)) | "- " + .[].title')
      if [ -z "$RELEASE_NOTES" ]; then
          echo "No new merge requests found since $LAST_DATE."
          exit 0
      fi
      echo "${RELEASE_NOTES}" > "$[[ inputs.release_notes_file ]]"
  artifacts:
    paths:
      - $[[ inputs.release_notes_file ]]
    expire_in: 1 day
  allow_failure: true
