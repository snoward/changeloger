spec:
  inputs:
    stage:
      default: deploy
    changelog_header:
      default: "Список релизов"
    changes_md_token:
      default: $CHANGES_MD_TOKEN
    changelog_file:
      default: CHANGELOG.md
    release_notes_file:
      default: release_notes.txt
---
actualize-changelog:
  stage: $[[ inputs.stage ]]
  image: docker-proxy.kontur.host/alpine/git:latest
  script:
    - |
      if [ ! -s "$[[ inputs.release_notes_file ]]" ]; then
          echo "File with release notes does not exist"
          exit 0
      fi

      CHANGELOG_FILE="$[[ inputs.changelog_file ]]"
      TEMP_FILE="$(mktemp)"
      {
          echo "$[[ inputs.changelog_header ]]"
          echo "## $(date +'%d.%m.%Y')"
          cat "$[[ inputs.release_notes_file ]]"
          echo ""
          if [ -s "$CHANGELOG_FILE" ]; then
              tail -n +2 "$CHANGELOG_FILE" | sed '$d'
          fi
      } > "$TEMP_FILE"

      mv "$TEMP_FILE" "$CHANGELOG_FILE"
      CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      echo "Last changelog update: ${CURRENT_DATE}" >> "$CHANGELOG_FILE"

      git config user.email "gitlab_ci@skbkontur.ru"
      git config user.name "Quality Bot"
      git add "$CHANGELOG_FILE"

      if ! git diff --cached --quiet; then
        git commit -m "update changelog [skip ci]" || echo "No changes to commit"
        git push "https://oauth2:$[[ inputs.changes_md_token ]]@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:${CI_COMMIT_REF_NAME}
      else
          echo "No changes to commit."
      fi
  allow_failure: true
